<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>BGLighing</title>
</head>
<body>

    <div id="three_render" style="width:600px;height:600px;float:left;"></div>

    <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
          "imports": {
            "three": "./node_modules/three/build/three.module.js"
          }
        }
    </script>

    <script type="module">

        import * as THREE from 'three';
        import { OrbitControls } from './node_modules/three/examples/jsm/controls/OrbitControls.js';
        import { GLTFLoader } from './node_modules/three/examples/jsm/loaders/GLTFLoader.js';

        const sphRadius = 100;

        function transformSphericalToWorld(theta, phi) {
            const wx = sphRadius * Math.cos(phi) * Math.cos(theta);
            const wy = sphRadius * Math.sin(phi);
            const wz = sphRadius * Math.cos(phi) * Math.sin(theta);
            return new THREE.Vector3(wx, wy, wz);
        }

        function setCameraFit(obj) {

            let bbox = new THREE.Box3();
            bbox.expandByObject(obj);
            let sz = new THREE.Vector3();
            bbox.getSize(sz);

            let as = Math.max(sz.x, sz.y);
            let dist = Math.sqrt(3.0) / 2.0 * as + sz.z;



            //console.log("camera dist fit = " + dist);

            let ctr = new THREE.Vector3();
            bbox.getCenter(ctr);

            controls.target.set(ctr.x, ctr.y, ctr.z);
            controls.update();

            camera.position.set(ctr.x, ctr.y + dist, ctr.z + dist);
            camera.lookAt(ctr.x, ctr.y, ctr.z);

            animate();
        }

        function screenToNormalized(px, py) {

            //rayLog(3, "mouse px : " + px + "," + py);

            var cx = (px / renderer.domElement.clientWidth) * 2.0 - 1.0;
            var cy = (1.0 - py / renderer.domElement.clientHeight) * 2.0 - 1.0;
            //rayLog(3, "normalized (-1,1) coord : " + cx + "," + cy);

            var nc = new THREE.Vector2(cx, cy);
            return nc;
        }



        var renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(600, 600);
        renderer.setClearColor(0xaaaaaa, 1);

        document.getElementById("three_render").appendChild(renderer.domElement);

        const scene = new THREE.Scene();

        const ambientLight = new THREE.AmbientLight(0xcccccc, 0.3);
        scene.add(ambientLight);

        const camera = new THREE.PerspectiveCamera(60, 1.0, 0.1, 1000);
        camera.position.set(1, 1, 1);
        scene.add(camera);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(10, 10, 10);
        scene.add(directionalLight);

        const cameraLight = new THREE.DirectionalLight(0xffffff, 0.5);
        cameraLight.position.set(0, 0, 0);
        cameraLight.target.position.set(0, 0, 0);
        camera.add(cameraLight);
        scene.add(cameraLight.target);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 0, 0);
        controls.update();

        const bgTex = new THREE.TextureLoader().load('../../data/sphere_plaza.jpg');
        const bgMat = new THREE.MeshBasicMaterial();
        bgMat.map = bgTex;
        const sph_geom = new THREE.SphereGeometry(sphRadius, 32, 32, 0, -2.0 * Math.PI);
        const bgMesh = new THREE.Mesh(sph_geom, bgMat);
        
        scene.add(bgMesh);


        const pointLight = new THREE.PointLight(0xff0000);
        pointLight.position.set(-3, 3, 0);
        scene.add(pointLight);
        const pointLightHelper = new THREE.PointLightHelper(pointLight);
        scene.add(pointLightHelper);


        const spotLight = new THREE.SpotLight(0x00ff00, 2.0, 2, Math.PI / 12.0);
        spotLight.position.set(0, 3, 0);
        scene.add(spotLight);
        const spotLightHelper = new THREE.SpotLightHelper(spotLight);
        scene.add(spotLightHelper);



        const root = new THREE.Group();
        scene.add(root);


        function render() {

            cameraLight.target.position.set(controls.target.x, controls.target.y, controls.target.z);

            renderer.render(scene, camera);
        }

        function animate() {
            requestAnimationFrame(animate);
            render();
        }


        animate();

        /*
        const gloader = new GLTFLoader().setPath("../../data/gltf/jinn1/");
        gloader.load("jinn1.gltf", function (gltf) {
            root.add(gltf.scene);
            setCameraFit(root);
            animate();
        });
        */

        const gloader = new GLTFLoader().setPath("../../data/gltf/zach_clo/");
        gloader.load("clo_sample.gltf", function (gltf) {
            root.add(gltf.scene);
            setCameraFit(root);
            animate();
        });


    </script>


</body>
</html>