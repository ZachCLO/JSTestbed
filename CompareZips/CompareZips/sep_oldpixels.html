<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Old 8-bit pixels Effect</title>
    <script type="text/javascript" src="node_modules/jszip/dist/jszip.js"></script>
</head>
<body>


    <div id="three_render" style="width:800px;height:600px;float:left;"></div>

    <p id="pixel_size" style="font-size:16pt;">Pixel Size = 8</p>
    <p id="pixel_box_border" style="font-size: 16pt;">Pixel Box Border = false</p>
    <p id="depth_edge_str" style="font-size: 16pt;">Depth Edge Str = 0.3</p>
    <p id="normal_edge_str" style="font-size: 16pt;">Normal Edge Str = 0.4</p>


    <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
          "imports": {
            "three": "./node_modules/three/build/three.module.js"
          }
        }
    </script>

    <script type="module">

        import * as THREE from 'three';
        import { OrbitControls } from './node_modules/three/examples/jsm/controls/OrbitControls.js';
        import { EffectComposer } from './node_modules/three/examples/jsm/postprocessing/EffectComposer.js';
        import { RenderPass } from './node_modules/three/examples/jsm/postprocessing/RenderPass.js';

        import { GLTFLoader } from './node_modules/three/examples/jsm/loaders/GLTFLoader.js';
        import { OldPixelsPass } from './OldPixelsPass.js';

        const eRender = document.getElementById("three_render");
        eRender.getBoundingClientRect();
        const rwidth = eRender.clientWidth;
        const rheight = eRender.clientHeight;

        var renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(rwidth, rheight);
        renderer.setClearColor(0xaaaaaa, 1);

        document.getElementById("three_render").appendChild(renderer.domElement);

        const scene = new THREE.Scene();

        const ambientLight = new THREE.AmbientLight(0xcccccc, 0.4);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(-10, -10, 10);
        directionalLight.lookAt(0, 0, 0);
        scene.add(directionalLight);

        const camera = new THREE.PerspectiveCamera(60, rwidth / rheight, 0.03, 100);
        camera.position.set(1, 1, 1);

        const cameraLight = new THREE.PointLight(0xffcccc, 1);
        camera.add(cameraLight);

        scene.add(camera);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 0, 0);
        controls.update();

        const root = new THREE.Group();
        scene.add(root);

        //const main_tex = new THREE.TextureLoader().load('../../data/checked.jpg');
        //const material = new THREE.MeshBasicMaterial({
        //    //map: main_tex,
        //color: 0xffffff,
        //});

        const composer = new EffectComposer(renderer);

        const defPass = new RenderPass(scene, camera);
        composer.addPass(defPass);

        const oldPixelsPass = new OldPixelsPass(8, scene, camera);
        oldPixelsPass.setSize(rwidth, rheight);
        oldPixelsPass.pixelBorders = false;
        //oldPixelsPass.depthEdgeStrength = 1;
        //oldPixelsPass.normalEdgeStrength = 1;

        composer.addPass(oldPixelsPass);
        let oldPixelsEnable = true;


        function render() {

            //uniforms["cdir"].value = cdir;
            //renderer.render(scene, camera);
            composer.render();
        }

        function animate() {
            requestAnimationFrame(animate);
            render();
        }

        function setCameraFit(obj) {

            let bbox = new THREE.Box3();
            bbox.expandByObject(obj);
            let sz = new THREE.Vector3();
            bbox.getSize(sz);

            let as = Math.max(sz.x, sz.y);
            let dist = Math.sqrt(3.0) / 2.0 * as + sz.z;

            //console.log("camera dist fit = " + dist);

            let ctr = new THREE.Vector3();
            bbox.getCenter(ctr);

            controls.target.set(ctr.x, ctr.y, ctr.z);
            controls.update();

            camera.position.set(ctr.x, ctr.y, ctr.z + dist);
            camera.lookAt(ctr.x, ctr.y, ctr.z);

            animate();
        }

        function screenToNormalized(px, py) {

            //rayLog(3, "mouse px : " + px + "," + py);

            var cx = (px / renderer.domElement.clientWidth) * 2.0 - 1.0;
            var cy = (1.0 - py / renderer.domElement.clientHeight) * 2.0 - 1.0;
            //rayLog(3, "normalized (-1,1) coord : " + cx + "," + cy);

            var nc = new THREE.Vector2(cx, cy);
            return nc;
        }

        animate();


        const gloader = new GLTFLoader().setPath("../../data/gltf/jinn1/");
        gloader.load("jinn1.gltf", function (gltf) {
            root.add(gltf.scene);
            setCameraFit(root);
            animate();
        });


        document.addEventListener('keyup', (event) => {
            if (event.key === '1') {
                if (oldPixelsEnable) {
                    composer.removePass(oldPixelsPass);
                    oldPixelsEnable = false;
                }
            }
            else if (event.key === '2') {
                if (!oldPixelsEnable) {
                    composer.addPass(oldPixelsPass);
                    oldPixelsEnable = true;
                }
            }
            else if (event.key === '3') {
                oldPixelsPass.pixelBorders = !oldPixelsPass.pixelBorders;
                document.getElementById("pixel_box_border").innerText = "Pixel Box Border = " + oldPixelsPass.pixelBorders;
            }
            else if (event.key === 'q') {
                let ps = oldPixelsPass.pixelSize;
                if (ps > 4) {
                    oldPixelsPass.setPixelSize(ps - 1);
                    console.log("pixel size " + oldPixelsPass.pixelSize);
                    document.getElementById("pixel_size").innerText = "Pixel Size = " + oldPixelsPass.pixelSize.toFixed(0);
                    animate();
                }
            }
            else if (event.key === 'w') {
                let ps = oldPixelsPass.pixelSize;
                if (ps < 32) {
                    oldPixelsPass.setPixelSize(ps + 1);
                    console.log("pixel size " + oldPixelsPass.pixelSize);
                    document.getElementById("pixel_size").innerText = "Pixel Size = " + oldPixelsPass.pixelSize.toFixed(0);
                    animate();
                }
            }
            else if (event.key === 'a') {
                let ps = oldPixelsPass.depthEdgeStrength;
                if (ps > 0.01) {
                    oldPixelsPass.depthEdgeStrength = ps - 0.1;
                    console.log("depth edge str " + oldPixelsPass.depthEdgeStrength);
                    document.getElementById("depth_edge_str").innerText = "Depth Edge Str = " + oldPixelsPass.depthEdgeStrength.toFixed(1);
                    animate();
                }
            }
            else if (event.key === 's') {
                let ps = oldPixelsPass.depthEdgeStrength;
                if (ps < 1.0) {
                    oldPixelsPass.depthEdgeStrength = ps + 0.1;
                    console.log("depth edge str " + oldPixelsPass.depthEdgeStrength);
                    document.getElementById("depth_edge_str").innerText = "Depth Edge Str = " + oldPixelsPass.depthEdgeStrength.toFixed(1);
                    animate();
                }
            }
            else if (event.key === 'z') {
                let ps = oldPixelsPass.normalEdgeStrength;
                if (ps > 0.01) {
                    oldPixelsPass.normalEdgeStrength = ps - 0.1;
                    console.log("normal edge str " + oldPixelsPass.normalEdgeStrength);
                    document.getElementById("normal_edge_str").innerText = "Normal Edge Str = " + oldPixelsPass.normalEdgeStrength.toFixed(1);
                    animate();
                }
            }
            else if (event.key === 'x') {
                let ps = oldPixelsPass.normalEdgeStrength;
                if (ps < 1.0) {
                    oldPixelsPass.normalEdgeStrength = ps + 0.1;
                    console.log("normal edge str " + oldPixelsPass.normalEdgeStrength);
                    document.getElementById("normal_edge_str").innerText = "Normal Edge Str = " + oldPixelsPass.normalEdgeStrength.toFixed(1);
                    animate();
                }
            }
        });



    </script>


</body>
</html>